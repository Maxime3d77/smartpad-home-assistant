#!/usr/bin/env bash
#### Smartpad Specific Tweaks for armbian images
####
#### Written by Stephan Wendel aka KwadFan <me@stephanwe.de>
#### Copyright 2023 - till today
#### https://github.com/KwadFan
####
#### This File is distributed under GPLv3
####

# shellcheck enable=require-variable-braces
# Source error handling, leave this in place
set -Ee

# Source CustomPIOS common.sh
# shellcheck disable=SC1091
source /common.sh
install_cleanup_trap

#echo_green "Move script..."
#unpack /filesystem/home/pi/
#echo_green "Move script...(DONE)"

echo_green "Install Docker Home Assistant..."

# Création du script install.sh
#cat << 'EOF' > /home/pi/install.sh
#!/bin/bash

# Mise à jour du systeme
sudo apt update && sudo apt upgrade -y

# Docker Installation
echo "1. Installation de Docker..."
sudo apt-get install -y docker.io
echo "1. Installation de Docker Compose Plugin..."
sudo apt-get install -y docker-compose-plugin


# preparation pour Home Assistant
sudo adduser --system --group homeassistant
sudo mkdir -p /home/homeassistant/.homeassistant
sudo chown -R homeassistant:homeassistant /home/homeassistant/.homeassistant
cd /home/homeassistant
cat <<'EOF' >> compose.yml
version: '3'
services:
  homeassistant:
    container_name: home-assistant
    image: "ghcr.io/home-assistant/home-assistant:stable"
    volumes:
      - /home/homeassistant/.homeassistant:/config
      - /etc/localtime:/etc/localtime:ro
      - /run/dbus:/run/dbus:ro
    restart: unless-stopped
    privileged: true
    network_mode: host
	
EOF

sudo docker compose up -d




echo "Installation terminée."
EOF


echo_green "Install Docker Home Assistant...(DONE)"
