#!/usr/bin/env bash
# CustomPiOS module : docker
# Original script written by Damien DALY (https://github.com/MaitreDede/)
# Changes by Guy Sheffer
# GPL V3
# shellcheck enable=require-variable-braces
# Source error handling, leave this in place
#set -Ee

# Source CustomPIOS common.sh
# shellcheck disable=SC1091
#source /common.sh
#install_cleanup_trap


echo_green "Install Home Assistant..."

echo_green "Install DEPENDENCIES..."
sudo apt-get update
sudo apt-get install -y python3 python3-dev python3-venv python3-pip bluez libffi-dev libssl-dev libjpeg-dev zlib1g-dev autoconf build-essential libopenjp2-7 libtiff6 libturbojpeg0-dev tzdata ffmpeg liblapack3 liblapack-dev libatlas-base-dev
echo_green "Install DEPENDENCIES...(DONE)"


echo_green "Add User..."
sudo useradd -rm homeassistant -G dialout,gpio,i2c
echo_green "Add User...(DONE)"

echo_green "Install CREATE THE VIRTUAL ENVIRONMENT..."
#sudo mkdir /srv/homeassistant
#sudo chown homeassistant:homeassistant /srv/homeassistant
cd /srv && sudo mkdir homeassistant && sudo chown homeassistant:homeassistant homeassistant
sudo -u homeassistant -H -s
cd /srv/homeassistant || exit
python3 -m venv .
#source /bin/activate
source /srv/homeassistant/bin/activate
python3 -m pip install wheel
pip3 install homeassistant
#python3 -m pip install homeassistant
echo_green "Install CREATE THE VIRTUAL ENVIRONMENT...(DONE)"
echo_green "Install Home Assistant...(DONE)"
